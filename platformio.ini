; PlatformIO Project Configuration File - Aquarium Management System
;
; This project contains multiple firmware targets:
; - hub_esp32: Central controller (ESP32-S3-N16R8)
; - node_fish_feeder: Fish feeder controller (ESP8266)
; - node_co2_regulator: CO2 regulator controller (ESP8266)
; - node_lighting: Lighting controller (ESP8266)
; - node_heater: Heater controller (ESP8266)
; - node_water_quality: Water quality sensors (ESP8266)
; - node_repeater: ESP-NOW range extender (ESP8266)
;
; Build specific target: pio run -e hub_esp32
; Upload specific target: pio run -e hub_esp32 -t upload

; ============================================================================
; SHARED CONFIGURATION
; ============================================================================
[platformio]
; Shared protocol definitions
include_dir = include
; All environments use src/ as base directory
src_dir = src

[common]
monitor_speed = 115200
build_flags = 
    -DESPNOW_CHANNEL=6
    -I include

[common_esp8266]
platform = espressif8266
board = nodemcuv2
framework = arduino
monitor_speed = ${common.monitor_speed}
upload_speed = 115200
build_flags = 
    ${common.build_flags}
    -DNODE_BUILD

; ============================================================================
; HUB - ESP32-S3 (Central Controller)
; ============================================================================
[env:hub_esp32]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = ${common.monitor_speed}
upload_speed = 921600

upload_port = /dev/ttyACM0

; Only compile hub main.cpp (exclude node files)
build_src_filter = +<*> -<nodes/>

; Data folder for LittleFS (WebUI files)
data_dir = src/hub/data
board_build.filesystem = littlefs

; Use 16MB flash with large SPIFFS partition scheme (9.375 MB)
; This gives: ~3MB app per OTA slot + 9.375MB LittleFS + OTA support + factory partition
board_build.flash_size = 16MB
board_build.partitions = app3M_spiffs9M_fact512k_16MB.csv
board_upload.flash_size = 16MB

build_flags = 
    ${common.build_flags}
    -DHUB_BUILD
    -DARDUINO_USB_CDC_ON_BOOT=1        ; Enable USB CDC for serial output
    -Os                                 ; Optimize for size
    -DCORE_DEBUG_LEVEL=3               ; Enable warning-level debugging
    -DCONFIG_ARDUHAL_LOG_DEFAULT_LEVEL=3

lib_deps = 
    tzapu/WiFiManager@^2.0.17
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git
    bblanchon/ArduinoJson@^7.2.0 
; ============================================================================
; NODES - ESP8266 (Peripheral Controllers)
; ============================================================================

; ----------------------------------------------------------------------------
; Fish Feeder Node
; ----------------------------------------------------------------------------
[env:node_fish_feeder]
platform = ${common_esp8266.platform}
board = ${common_esp8266.board}
framework = ${common_esp8266.framework}
monitor_speed = ${common_esp8266.monitor_speed}
upload_speed = ${common_esp8266.upload_speed}

; Only compile fish feeder node files
build_src_filter = +<nodes/fish_feeder/src/> -<nodes/co2_regulator/> -<nodes/lighting/> -<nodes/heater/> -<nodes/water_quality/> -<nodes/repeater/> -<main.cpp>

build_flags = 
    ${common_esp8266.build_flags}
    -DNODE_TYPE_FISH_FEEDER

; ----------------------------------------------------------------------------
; CO2 Regulator Node
; ----------------------------------------------------------------------------
[env:node_co2_regulator]
platform = ${common_esp8266.platform}
board = ${common_esp8266.board}
framework = ${common_esp8266.framework}
monitor_speed = ${common_esp8266.monitor_speed}
upload_speed = ${common_esp8266.upload_speed}

; Only compile CO2 regulator node files
build_src_filter = +<nodes/co2_regulator/src/> -<nodes/fish_feeder/> -<nodes/lighting/> -<nodes/heater/> -<nodes/water_quality/> -<nodes/repeater/> -<main.cpp>

build_flags = 
    ${common_esp8266.build_flags}
    -DNODE_TYPE_CO2

; ----------------------------------------------------------------------------
; Lighting Node
; ----------------------------------------------------------------------------
[env:node_lighting]
platform = ${common_esp8266.platform}
board = ${common_esp8266.board}
framework = ${common_esp8266.framework}
monitor_speed = ${common_esp8266.monitor_speed}
upload_speed = ${common_esp8266.upload_speed}

upload_port = /dev/ttyUSB0

; Only compile lighting node files
build_src_filter = +<nodes/lighting/src/> -<nodes/fish_feeder/> -<nodes/co2_regulator/> -<nodes/heater/> -<nodes/water_quality/> -<nodes/repeater/> -<main.cpp>

build_flags = 
    ${common_esp8266.build_flags}
    -DNODE_TYPE_LIGHT

; ----------------------------------------------------------------------------
; Heater Node
; ----------------------------------------------------------------------------
[env:node_heater]
platform = ${common_esp8266.platform}
board = ${common_esp8266.board}
framework = ${common_esp8266.framework}
monitor_speed = ${common_esp8266.monitor_speed}
upload_speed = ${common_esp8266.upload_speed}

; Only compile heater node files
build_src_filter = +<nodes/heater/src/> -<nodes/fish_feeder/> -<nodes/co2_regulator/> -<nodes/lighting/> -<nodes/water_quality/> -<nodes/repeater/> -<main.cpp>

build_flags = 
    ${common_esp8266.build_flags}
    -DNODE_TYPE_HEATER

; ----------------------------------------------------------------------------
; Water Quality Sensor Node
; ----------------------------------------------------------------------------
[env:node_water_quality]
platform = ${common_esp8266.platform}
board = ${common_esp8266.board}
framework = ${common_esp8266.framework}
monitor_speed = ${common_esp8266.monitor_speed}
upload_speed = ${common_esp8266.upload_speed}

; Only compile water quality node files
build_src_filter = +<nodes/water_quality/src/> -<nodes/fish_feeder/> -<nodes/co2_regulator/> -<nodes/lighting/> -<nodes/heater/> -<nodes/repeater/> -<main.cpp>

build_flags = 
    ${common_esp8266.build_flags}
    -DNODE_TYPE_SENSOR

; ----------------------------------------------------------------------------
; Repeater Node (Range Extender)
; ----------------------------------------------------------------------------
[env:node_repeater]
platform = ${common_esp8266.platform}
board = ${common_esp8266.board}
framework = ${common_esp8266.framework}
monitor_speed = ${common_esp8266.monitor_speed}
upload_speed = ${common_esp8266.upload_speed}

; Only compile repeater node files
build_src_filter = +<nodes/repeater/src/> -<nodes/fish_feeder/> -<nodes/co2_regulator/> -<nodes/lighting/> -<nodes/heater/> -<nodes/water_quality/> -<main.cpp>

build_flags = 
    ${common_esp8266.build_flags}
    -DNODE_TYPE_REPEATER
